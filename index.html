<!DOCTYPE html>
<html lang="ja">
<head>

  <meta name="description" content="é™¸ä¸Šã®ç·´ç¿’ã‚’è¨˜éŒ²ãƒ»å¯è¦–åŒ–ã™ã‚‹AthLog">
  <meta property="og:title" content="AthLog">
  <meta property="og:description" content="é™¸ä¸Šã®ç·´ç¿’ã‚’è¨˜éŒ²ãƒ»å¯è¦–åŒ–">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://gddgfr4.github.io/AthLog1/">
  <meta property="og:image" content="./athlog-icon-512.png">
  <meta name="twitter:card" content="summary_large_image">

  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>AthLog</title>

  <!-- PWA/ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç„¡ã‘ã‚Œã°å‰Šã£ã¦ã‚‚å‹•ä½œOKï¼‰ -->
  <link rel="manifest" href="./manifest.webmanifest?v=2">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16.png">
  <link rel="apple-touch-icon" href="./apple-touch-icon-180.png">

  <!-- ãƒ™ãƒ¼ã‚¹CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- ç­‹ãƒãƒƒãƒ—ç”»åƒã‚’å…ˆèª­ã¿ï¼ˆåŒéšå±¤ã« human.webp ã‚’ç½®ãï¼‰ -->
  <link rel="preload" href="human.webp" as="image" imagesrcset="human.webp" />

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="app" class="app hidden">
    <header class="topbar">
      <button class="ghost" id="openHelpBtn">ãƒ˜ãƒ«ãƒ—</button>
      <div class="brand">AthLog</div> <div class="teamuser" style="display:flex; align-items:center; gap:12px;">
        <span>Team: <b id="teamLabel"></b></span>
        <span id="memberNavWrap" style="display:flex; align-items:center; gap:4px;">
          <button id="memberPrev" class="ghost small-btn" title="å‰ã®ãƒ¡ãƒ³ãƒãƒ¼ã¸">&lt;</button>
          <span style="display:flex; align-items:center; gap:8px;">
            è¡¨ç¤ºä¸­: <b id="memberLabel"></b>
            <span id="mainTeamBadge" class="badge primary hidden" title="ã“ã®ãƒãƒ¼ãƒ ã¯ã‚ãªãŸã®ãƒ¡ã‚¤ãƒ³ã§ã™">MAIN</span>
            <span id="readonlyBadge" class="badge warn hidden" title="ã“ã®ãƒãƒ¼ãƒ ã§ã¯ç·¨é›†ã§ãã¾ã›ã‚“">é–²è¦§ã®ã¿</span>
          </span>
          <select id="memberSelect" class="ghost" style="padding: 4px 6px;"></select>
          <button id="memberNext" class="ghost small-btn" title="æ¬¡ã®ãƒ¡ãƒ³ãƒãƒ¼ã¸">&gt;</button>
        </span>
        <div id="teamSwitchWrap" class="team-switch" style="display:flex; align-items:center; gap:8px;">
          <span class="muted">ãƒãƒ¼ãƒ :</span>
          <select id="teamSwitchSelect" class="ghost" style="padding:4px 6px; min-width:140px;"></select>
          <button id="addTeamBtn" class="ghost">ï¼‹è¿½åŠ </button>
          <button id="setAsMainBtn" class="ghost" title="ã“ã®ãƒãƒ¼ãƒ ã‚’ãƒ¡ã‚¤ãƒ³ã«ã™ã‚‹">ãƒ¡ã‚¤ãƒ³ã«è¨­å®š</button>
        </div>
        <button id="logoutBtn" class="ghost">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </header>
    <nav class="tabs">
      <button data-tab="journal" class="tab active">æ—¥èªŒ</button>
      <button data-tab="month" class="tab">æœˆä¸€è¦§</button>
      <button data-tab="plans" class="tab">äºˆå®š</button>
      <button data-tab="dashboard" class="tab">ã‚°ãƒ©ãƒ•</button>
      <button data-tab="memo" class="tab">ãƒ¡ãƒ¢</button>
      <button data-tab="notify" class="tab">é€šçŸ¥</button>
      <button class="tab" data-tab="clock">æ™‚è¨ˆ</button>
      <button class="tab" data-tab="stadium">ç«¶æŠ€å ´</button>
    </nav>
    <!-- ç”»é¢ä¸Šéƒ¨ å…±é€šã‚¹ãƒ¯ã‚¤ãƒ—ãƒãƒ¼ï¼ˆé€æ˜ï¼‰ -->
    <div id="globalSwipeBar" aria-hidden="true"></div>


    <!-- ===== JOURNAL ===== -->
    <section id="journal" class="tabpanel active">
      <div class="journal-grid">
        <div class="panel">
          <div class="muscle-header">
            <h3>ç­‹ç–²åŠ´</h3>
            <div class="palette">
              <button class="lvl active" data-lvl="1"><span class="dot dot1"></span>1</button>
              <button class="lvl" data-lvl="2"><span class="dot dot2"></span>2</button>
              <button class="lvl" data-lvl="3"><span class="dot dot3"></span>3</button>
              <button id="eraser" class="lvl">ğŸ§¼</button>
            </div>
          </div>
          <div id="mmWrap">
            <!-- è¡¨ç¤ºç”¨ã®ä¸‹åœ°ç”»åƒï¼ˆpointer-events: none ã§æ“ä½œã¯ä¸Šã®Canvasã¸ï¼‰ -->
            <img id="mmBg" src="./human.webp" alt="" style="display:block;width:100%;height:auto;pointer-events:none;">

            <!-- è§£æç”¨ãƒ™ãƒ¼ã‚¹ï¼ˆéè¡¨ç¤ºã§OK / JSãŒæç”»ã«ä½¿ç”¨ï¼‰ -->
            <canvas id="mmBase"></canvas>

            <!-- è¦‹ãˆãªã„â€œå£â€ -->
            <canvas id="mmBarrier"></canvas>

            <!-- ãƒ¦ãƒ¼ã‚¶ãŒå¡—ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <canvas id="mmOverlay"></canvas>
          </div>
        </div>

        <div class="panel right">
          <div class="weekbar">
            <button id="weekPrev" class="ghost">&larr;</button>
            <div id="weekChips" class="chips"></div>
            <button id="weekNext" class="ghost">&rarr;</button>
            <span id="weekMonthLabel" class="muted"></span>
            <input type="date" id="datePicker" />
            <button id="gotoToday" class="ghost">ä»Šæ—¥ã¸</button>
            <button id="shareModeBtn" class="ghost" title="ã‚¹ã‚¯ã‚·ãƒ§ç”¨ãƒ¢ãƒ¼ãƒ‰" style="margin-left:4px; padding:4px 8px;">ğŸ“·</button>
          </div>

          <div class="quick" style="justify-content:center;">
            <button class="qbtn jog">ã‚¸ãƒ§ã‚°</button>
            <button class="qbtn point">ãƒã‚¤ãƒ³ãƒˆ</button>
            <button class="qbtn sup">è£œå¼·</button>
            <button class="qbtn off">ã‚ªãƒ•</button>
            <button class="qbtn other">ãã®ä»–</button>
          </div>

          <div class="formcol">
            <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
              
              <div style="width: 70px;">
                <label style="font-size:11px; white-space:nowrap;">è·é›¢(km)</label>
                <input type="number" id="distInput" step="0.1" min="0" style="padding:6px;" />
              </div>

              <div style="width: 70px;">
                <label style="font-size:11px; white-space:nowrap;">ä½“é‡(kg)</label>
                <input type="number" id="weightInput" step="0.1" min="0" style="padding:6px;" />
              </div>

              <div style="flex:1; min-width:150px;">
                <label style="font-size:11px;">èª¿å­</label>
                <div id="conditionBtns" class="condition-rating" style="margin-top:1px;">
                  <button data-val="1">1</button>
                  <button data-val="2">2</button>
                  <button data-val="3">3</button>
                  <button data-val="4">4</button>
                  <button data-val="5">5</button>
                </div>
              </div>
            </div>
            <div class="note">
              <label>ç·´ç¿’å†…å®¹</label>
              <textarea id="trainInput" rows="3"></textarea>
              <div class="merge">
                <select id="mergeScope" class="ghost"></select>
                <input id="mergeTagFilter" class="ghost" placeholder="ã‚¿ã‚°(,åŒºåˆ‡ã‚Š)" />
                <button id="mergeBtn" class="ghost">åæ˜ </button>
              </div>
            </div>

            <div class="note">
              <label>ã‚¿ã‚¤ãƒ ãƒ»æ„Ÿæƒ³</label>
              <textarea id="feelInput" rows="6"></textarea>
            </div>

            <div class="savebar">
             <div id="distanceSummary" class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
            </div>

      
            <div class="note" id="teamSharedCommentBox">
              <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
              <textarea id="teamSharedComment" rows="3" placeholder="ã“ã®æ—¥ã®å…±æœ‰ã‚³ãƒ¡ãƒ³ãƒˆâ€¦"></textarea>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                <div id="teamSharedCommentStatus" class="muted" style="font-size:12px;"></div>
                <button id="tscSendBtn" class="primary" style="padding:6px 12px; font-size:12px;">é€ä¿¡</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== MONTH LIST ===== -->
    <section id="month" class="tabpanel">
      <div class="monthbar">
        <button id="mPrev" class="ghost">&larr;</button>
        <input type="month" id="monthPick" />
        <button id="mNext" class="ghost">&rarr;</button>
        <div id="monthSum" class="muted"></div>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <label for="monthGoalInput"><strong>æœˆé–“ç›®æ¨™</strong></label>
        <textarea id="monthGoalInput" class="form-control" rows="2" style="width:100%; margin-top:4px;"></textarea>
      </div>

      <div id="monthList" class="list"></div>
    </section>

    <!-- ===== PLANS ===== -->
    <section id="plans" class="tabpanel">
      <div class="monthbar">
        <button id="pPrev" class="ghost">&larr;</button>
        <input type="month" id="planMonthPick" />
        <button id="pNext" class="ghost">&rarr;</button>
        <div class="filters" style="margin-left:auto;">
          <select id="planScope" class="ghost"></select>
          <input id="tagFilter" placeholder="ã‚¿ã‚°(,åŒºåˆ‡ã‚Š)" />
        </div>
      </div>

      <!-- â–¼ è¿½åŠ : äºˆå®šå…¥åŠ›ã®ãƒã‚¤ãƒ³ãƒˆè©³ç´°ï¼ˆãƒã‚¤ãƒ³ãƒˆæ™‚ã®ã¿ä½¿ç”¨ï¼‰ -->
      <div class="panel" id="planAdvanced" style="display:none; gap:8px; align-items:center;">
        <label>ãƒã‚¤ãƒ³ãƒˆç¨®åˆ¥</label>
        <select id="pointSubtype">
          <option value="pace">ãƒšãƒ¼ã‚¹èµ°</option>
          <option value="interval">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«</option>
        </select>
        <label>è·é›¢(m)</label>
        <input id="pointDistance" type="number" min="50" step="50" placeholder="1000" />
      </div>

      <div class="chatwrap" style="margin-bottom:12px;">
        <button id="toggleChat" class="ghost">æœˆã‚³ãƒ¡ãƒ³ãƒˆ</button>
        <div id="chatBox" class="chat hidden">
          <div id="chatLog" class="chatlog"></div>
          <input id="chatInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ..." />
        </div>
      </div>

      <div id="planList" class="list"></div>
    </section>
    <!-- ===== DASHBOARD ===== -->
    <section id="dashboard" class="tabpanel">
      <div class="panel" style="margin-bottom:12px;">
        <!-- æ—§: åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚„1æšã‚­ãƒ£ãƒ³ãƒã‚¹ã¯å‰Šé™¤ -->
        <!-- æ–°: 3æšã®è·é›¢ã‚°ãƒ©ãƒ•ã‚’ç¸¦ä¸¦ã³ -->
    
        <div class="card">
          <h3>
            <button id="distDayPrev" class="ghost" style="margin-right:6px;">&larr;</button>
            <span id="distChartTitleDay">æ—¥åˆ¥èµ°è¡Œè·é›¢ï¼ˆç›´è¿‘14æ—¥ï¼‰</span>
            <button id="distDayNext" class="ghost" style="margin-left:6px;">&rarr;</button>
          </h3>
          <canvas id="distanceChartDay" height="180"></canvas>
        </div>
    
        <div class="card">
          <h3>
            <button id="distWeekPrev" class="ghost" style="margin-right:6px;">&larr;</button>
            <span id="distChartTitleWeek">é€±é–“èµ°è¡Œè·é›¢ï¼ˆç›´è¿‘6é€±ï¼‰</span>
            <button id="distWeekNext" class="ghost" style="margin-left:6px;">&rarr;</button>
          </h3>
          <canvas id="distanceChartWeek" height="180"></canvas>
        </div>
    
        <div class="card">
          <h3>
            <button id="distMonthPrev" class="ghost" style="margin-right:6px;">&larr;</button>
            <span id="distChartTitleMonth">æœˆé–“èµ°è¡Œè·é›¢ï¼ˆç›´è¿‘6ã‹æœˆï¼‰</span>
            <button id="distMonthNext" class="ghost" style="margin-left:6px;">&rarr;</button>
          </h3>
          <canvas id="distanceChartMonth" height="180"></canvas>
        </div>
      </div>
    
      <div class="panel">
        <div class="dash-header">
          <h3>ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æ¨ç§»</h3>
          <div class="dash-controls">
            <button id="condChartPrev" class="ghost">&larr;</button>
            <span id="condChartRange" class="muted"></span>
            <button id="condChartNext" class="ghost">&rarr;</button>
          </div>
        </div>
        <div style="height:250px;">
          <canvas id="conditionChart"></canvas>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
      <div class="dash-header">
        <h3>ä½“é‡æ¨ç§»</h3>
        <div class="dash-controls">
          <button id="weightModeBtn" class="ghost" style="font-size:12px; min-width:40px;">æ—¥</button>
          <button id="weightPrev" class="ghost">&larr;</button>
          <span id="weightRangeLabel" class="muted" style="font-size:12px;"></span>
          <button id="weightNext" class="ghost">&rarr;</button>
        </div>
      </div>
      <div style="height:200px;">
        <canvas id="weightChart"></canvas>
      </div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <h3 id="typePieTitle">ç·´ç¿’å‰²åˆ</h3>
      <div style="height:220px; position:relative;">
        <canvas id="typePieChart"></canvas>
      </div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <div class="dash-header">
        <h3>AIã‚³ãƒ¼ãƒåˆ†æ</h3>
      </div>
      
      <div id="aiConfig" style="margin-bottom:10px;">
        <label style="font-size:10px; color:#666;">Gemini API Key (æœªå…¥åŠ›ãªã‚‰æ©Ÿèƒ½ã‚ªãƒ•)</label>
        <input type="password" id="geminiApiKey" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ä¿å­˜" class="form-control" style="font-size:12px; margin-top:4px;" />
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
        <div class="muted" style="font-size:11px;">ç›´è¿‘7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ</div>
        <button id="runAiBtn" class="primary" style="padding:6px 12px; font-size:12px;">åˆ†æé–‹å§‹</button>
      </div>

      <div id="aiResult" class="note" style="margin-top:10px; min-height:60px; font-size:13px; line-height:1.5; white-space:pre-wrap; display:none;"></div>
    </div>
    </section>



    <!-- ===== TEAM MEMO ===== -->
    <section id="memo" class="tabpanel">
      <div class="panel">
        <h3>ãƒãƒ¼ãƒ ãƒ¡ãƒ¢</h3>
        <div id="memoChatBox" class="chat">
          <div id="memoChatLog" class="chatlog" style="max-height:400px;"></div>
          <div class="chat-input-area">
            <input id="memoChatInput" class="form-control" placeholder="ãƒãƒ¼ãƒ å…¨ä½“ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." />
            <button id="memoSendBtn" class="primary">é€ä¿¡</button>
          </div>
        </div>
      </div>
    </section>

    <section id="notify" class="tabpanel">
      <div class="panel">
        <h3>é€šçŸ¥</h3>
        <div id="notifyList" class="chatlog"></div>
        <div class="muted" id="notifyEmpty" style="display:none; padding:12px 0;">
          æ–°ã—ã„é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“
        </div>
      </div>
    </section>
  </div>

  <!-- LOGIN -->
  <div id="login" class="login">
    <div class="login-card">
      <div class="logo">AthLog</div>
      <div class="desc">ä¸­é•·è·é›¢ã®ãŸã‚ã®æ—¥èªŒ</div>
      <label>Team ID</label>
      <input id="teamId" />
      <label>Member</label>
      <input id="memberName" />
      <button id="loginBtn" class="primary wide">ã¯ã˜ã‚ã‚‹</button>
    </div>
  </div>

  <!-- Firebase SDKï¼ˆâ€»äºŒé‡èª­è¾¼ã¯ã—ãªã„ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- â† ã“ã®â€œç›´å¾Œâ€ã«åˆæœŸåŒ–ã‚’ç½®ãï¼ˆapp.jsã‚ˆã‚Šå‰ï¼‰ -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA8oCOusnqZCSax9ZY3-n4KNt2AxEmvT-E",
      authDomain: "athlog-126d2.firebaseapp.com",
      projectId: "athlog-126d2",
      storageBucket: "athlog-126d2.appspot.com",
      messagingSenderId: "784178114661",
      appId: "1:784178114661:web:d41103b0dad1187b85168c"
    };
    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>
  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <script src="app.js?v=20250824" defer></script>

  <!-- ãƒ˜ãƒ«ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="helpOverlay" class="login hidden">
    <div class="login-card" style="max-width:860px; width:min(96vw,860px); max-height:85vh; overflow:auto;">
      <div class="logo">AthLog ã‚¯ã‚¤ãƒƒã‚¯ã‚¬ã‚¤ãƒ‰</div>
      <div class="desc">æœ€çŸ­ã§ä½¿ã„å§‹ã‚ã‚‹ãŸã‚ã®è¦ç‚¹ã¾ã¨ã‚</div>
      <div id="helpBody" class="doc"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button class="ghost" id="helpClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <noscript>
    <div style="padding:16px; font-family: system-ui, -apple-system, Segoe UI, Roboto;">
      ã“ã®ã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ JavaScript ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚
    </div>
  </noscript>
 

<script>
/* ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®æ³¨æ„æ›¸ãã‚’è¿½åŠ ï¼ˆIDã¯å®Ÿä½“ã«åˆã‚ã›ã¦ loginBtnï¼‰ ===== */
(function(){
  function addLoginNote(){
    const startBtn = document.getElementById('loginBtn');
    if(!startBtn) return;
    if (document.querySelector('.login-note')) return; // é‡è¤‡é˜²æ­¢
    const note = document.createElement('p');
    note.className = 'login-note';
    note.innerHTML =
      'â€» æ¬¡å›ä»¥é™ã¯è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã¨ãªã‚Šã¾ã™ã€‚<br>' +
      'â€» ãƒãƒ¼ãƒ åã¨åå‰ã¯<strong>å®Œå…¨ä¸€è‡´</strong>ãŒå¿…è¦ã§ã™ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚„å…¨è§’ãƒ»åŠè§’ã«ã”æ³¨æ„ãã ã•ã„ï¼‰ã€‚';
    startBtn.insertAdjacentElement('afterend', note);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addLoginNote);
  } else {
    addLoginNote();
  }
})();
</script>

<script>
/* ===== äºˆå®š: ãƒã‚¤ãƒ³ãƒˆè©³ç´°ï¼ˆãƒã‚¤ãƒ³ãƒˆé¸æŠæ™‚ã ã‘è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ•ãƒƒã‚¯ã€‚æ—¢å­˜UIå´ã‹ã‚‰ä½¿ã†ï¼‰ ===== */
(function(){
  // ã‚‚ã—æ—¢å­˜ã®äºˆå®šå…¥åŠ›UIãŒ select#planType ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã®ä¾‹ã€‚ç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ã€‚
  const typeSel = document.getElementById('planType') || document.getElementById('sessionType');
  const adv = document.getElementById('planAdvanced');
  if (!adv) return;
  function sync(){ adv.style.display = (typeSel && typeSel.value === 'point') ? 'flex' : 'none'; }
  if (typeSel) { typeSel.addEventListener('change', sync); sync(); }
})();
</script>



<script>
(function(){
  try {
    if (!window.firebase || !firebase.firestore) return; // Firestoreæœªèª­è¾¼ãªã‚‰ä½•ã‚‚ã—ãªã„
  } catch(e) { return; }

  const db = firebase.firestore();

  function getDateKey(){
    const inp = document.getElementById('datePicker');
    const val = inp && inp.value;
    if (val && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  const $text = document.getElementById('daynote-text');
  const $status = document.getElementById('daynote-status');
  if (!$text || !$status) return; // DOMãŒç„¡ã„ç”»é¢ã§ã¯å®Ÿè¡Œã—ãªã„

  let currentDateKey = null;
  let saveTimer = null, dirty = false;

  async function loadNote(dateKey){
    try{
      const snap = await db.collection('dayNotes').doc(dateKey).get();
      $text.value = snap.exists ? (snap.data().text || '') : '';
      $status.textContent = `æ—¥ä»˜: ${dateKey} ï¼ çŠ¶æ…‹: å‚ç…§OK`;
    }catch(e){
      console.error(e);
      $status.textContent = `æ—¥ä»˜: ${dateKey} ï¼ èª­ã¿è¾¼ã¿å¤±æ•—`;
    }
  }

  async function saveNote(dateKey, text){
    try{
      await db.collection('dayNotes').doc(dateKey).set(
        { text, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
        { merge: true }
      );
      dirty = false;
      $status.textContent = `æ—¥ä»˜: ${dateKey} ï¼ ä¿å­˜æ¸ˆã¿`;
    }catch(e){
      console.error(e);
      $status.textContent = `æ—¥ä»˜: ${dateKey} ï¼ ä¿å­˜å¤±æ•—ï¼ˆè‡ªå‹•å†è©¦è¡Œï¼‰`;
      setTimeout(()=>scheduleSave(), 1500);
    }
  }

  function scheduleSave(){
    dirty = true;
    const dateKey = currentDateKey || getDateKey();
    $status.textContent = `æ—¥ä»˜: ${dateKey} ï¼ ä¿å­˜å¾…ã¡â€¦`;
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      saveNote(dateKey, $text.value);
    }, 800);
  }

  function init(){
    currentDateKey = getDateKey();
    loadNote(currentDateKey);
  }

  $text.addEventListener('input', scheduleSave);

  const datePicker = document.getElementById('datePicker');
  if (datePicker) {
    datePicker.addEventListener('change', ()=>{
      currentDateKey = getDateKey();
      loadNote(currentDateKey);
    });
  }

  window.addEventListener('beforeunload', ()=>{
    if (dirty) {
      try { saveNote(currentDateKey || getDateKey(), $text.value); } catch(e){}
    }
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
<!-- â–²â–² æœ€çµ‚ç‰ˆã“ã“ã¾ã§ â–²â–² -->
<!-- index.html: bodyé–‰ã˜ã‚¿ã‚°ç›´å‰ã«è¿½åŠ  -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
</script>

</body>
</html>





















